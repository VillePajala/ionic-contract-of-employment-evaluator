<ion-header>
  <ion-toolbar class="app-toolbar">
    <ion-buttons slot="start">
      <ion-button size="small" color="medium" (click)="language.toggle()">
        {{ language.getOtherLanguage().toUpperCase() }}
      </ion-button>
    </ion-buttons>
    <ion-title>{{ 'calculator.title' | translate }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- PWA Install Prompt -->
  @if (pwaInstall.canInstall()) {
    <ion-card class="install-card">
      <ion-card-content>
        <div class="install-content">
          <ion-icon name="download-outline" class="install-icon"></ion-icon>
          <div class="install-text">
            <h3>{{ 'pwa.installTitle' | translate }}</h3>
            <p>{{ 'pwa.installMessage' | translate }}</p>
          </div>
          <div class="install-actions">
            <ion-button size="small" shape="round" (click)="pwaInstall.install()">
              {{ 'pwa.install' | translate }}
            </ion-button>
            <ion-button size="small" fill="clear" (click)="pwaInstall.dismiss()">
              {{ 'pwa.later' | translate }}
            </ion-button>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  }

  <!-- Main Input Card -->
  <ion-card class="mainCard">
    <ion-card-header>
      <ion-card-title class="ion-text-center">{{ 'calculator.enterGrossSalary' | translate }}</ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <!-- Gross Salary Input -->
      <ion-item>
        <ion-label position="stacked">{{ 'calculator.grossSalary' | translate }}</ion-label>
        <ion-input
          type="tel"
          [value]="grossSalary()"
          (ionInput)="grossSalary.set($any($event.target).value)"
          inputmode="decimal"
          placeholder="0"
        ></ion-input>
      </ion-item>

      <!-- Yearly Bonus Input (toggleable) -->
      @if (showBonusInput()) {
        <ion-item>
          <ion-label position="stacked">{{ 'calculator.yearlyBonus' | translate }}</ion-label>
          <ion-input
            type="tel"
            [value]="yearlyBonus()"
            (ionInput)="yearlyBonus.set($any($event.target).value)"
            inputmode="decimal"
            placeholder="0"
          ></ion-input>
        </ion-item>
      }

      <!-- Age Range Selector -->
      <ion-item lines="none" class="options-section age-range-item">
        <ion-label position="stacked">{{ 'calculator.ageRange' | translate }}</ion-label>
        <ion-segment scrollable="true" [value]="selectedAgeRange()" (ionChange)="onAgeRangeChange($event)">
          <ion-segment-button value="17-52">
            <ion-label>17-52</ion-label>
          </ion-segment-button>
          <ion-segment-button value="53-62">
            <ion-label>53-62</ion-label>
          </ion-segment-button>
          <ion-segment-button value="63+">
            <ion-label>63+</ion-label>
          </ion-segment-button>
        </ion-segment>
      </ion-item>

      <!-- Municipality Selector -->
      <ion-item>
        <ion-label position="stacked">{{ 'calculator.municipality' | translate }}</ion-label>
        <ion-select
          [value]="useCustomRate() ? 'custom' : selectedMunicipality()"
          (ionChange)="onMunicipalityChange($event)"
          interface="popover"
        >
          @for (municipality of municipalities; track municipality.name) {
            <ion-select-option [value]="municipality.name">
              {{ municipality.name }} ({{ municipality.rate }}%)
            </ion-select-option>
          }
          <ion-select-option value="custom">{{ 'calculator.customRate' | translate }}</ion-select-option>
        </ion-select>
      </ion-item>

      <!-- Custom Municipal Rate Input -->
      @if (useCustomRate()) {
        <ion-item>
          <ion-label position="stacked">{{ 'calculator.municipalRate' | translate }} (%)</ion-label>
          <ion-input
            type="tel"
            [value]="customMunicipalRate()"
            (ionInput)="customMunicipalRate.set($any($event.target).value); onCustomRateChange()"
            inputmode="decimal"
            placeholder="7.5"
          ></ion-input>
        </ion-item>
      }

      <!-- Church Membership Toggle -->
      <ion-item>
        <ion-label>{{ 'calculator.churchMember' | translate }}</ion-label>
        <ion-toggle
          slot="end"
          [checked]="isChurchMember()"
          (ionChange)="onChurchMemberChange($event)"
        ></ion-toggle>
      </ion-item>

      <!-- Action Buttons -->
      <div class="ion-text-center ion-margin-top">
        <ion-button shape="round" (click)="calculate()">
          {{ 'calculator.calculate' | translate }}
        </ion-button>
        <ion-button size="small" fill="outline" shape="round" (click)="toggleBonus()">
          {{ 'calculator.bonuses' | translate }}
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Result Card -->
  @if (result(); as res) {
    <ion-card class="mainCard2">
      <ion-card-header>
        <ion-card-title class="ion-text-center" id="highlightText2">
          {{ 'calculator.netSalary' | translate }}: {{ res.netMonthlySalary | number:'1.0-0' }} {{ 'common.perMonth' | translate }}
        </ion-card-title>
        <ion-card-subtitle class="ion-text-center">
          {{ 'calculator.estimatedTaxRate' | translate }}: {{ res.effectiveTaxRate | number:'1.1-1' }}%
        </ion-card-subtitle>
        <ion-card-subtitle class="ion-text-center">
          {{ 'calculator.totalDeductions' | translate }}: {{ res.monthlyTaxPaid | number:'1.0-0' }} {{ 'common.perMonth' | translate }}
        </ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <!-- Toggle Breakdown Button -->
        <div class="ion-text-center ion-margin-bottom">
          <ion-button size="small" fill="clear" (click)="toggleBreakdown()">
            {{ showBreakdown() ? ('calculator.hideBreakdown' | translate) : ('calculator.showBreakdown' | translate) }}
          </ion-button>
        </div>

        <!-- Detailed Breakdown -->
        @if (showBreakdown()) {
          <ion-list class="breakdown-list">
            <ion-item>
              <ion-label>{{ 'calculator.breakdown.stateTax' | translate }}</ion-label>
              <ion-text slot="end">{{ res.breakdown.stateTax | number:'1.0-0' }} €</ion-text>
            </ion-item>
            <ion-item>
              <ion-label>{{ 'calculator.breakdown.municipalTax' | translate }}</ion-label>
              <ion-text slot="end">{{ res.breakdown.municipalTax | number:'1.0-0' }} €</ion-text>
            </ion-item>
            @if (res.breakdown.churchTax > 0) {
              <ion-item>
                <ion-label>{{ 'calculator.breakdown.churchTax' | translate }}</ion-label>
                <ion-text slot="end">{{ res.breakdown.churchTax | number:'1.0-0' }} €</ion-text>
              </ion-item>
            }
            <ion-item>
              <ion-label>{{ 'calculator.breakdown.pension' | translate }}</ion-label>
              <ion-text slot="end">{{ res.breakdown.pensionContribution | number:'1.0-0' }} €</ion-text>
            </ion-item>
            <ion-item>
              <ion-label>{{ 'calculator.breakdown.unemployment' | translate }}</ion-label>
              <ion-text slot="end">{{ res.breakdown.unemploymentContribution | number:'1.0-0' }} €</ion-text>
            </ion-item>
            <ion-item>
              <ion-label>{{ 'calculator.breakdown.healthInsurance' | translate }}</ion-label>
              <ion-text slot="end">{{ res.breakdown.healthInsurance | number:'1.0-0' }} €</ion-text>
            </ion-item>
            <ion-item class="credit-item">
              <ion-label>{{ 'calculator.breakdown.workIncomeCredit' | translate }}</ion-label>
              <ion-text slot="end" color="success">-{{ res.breakdown.workIncomeCredit | number:'1.0-0' }} €</ion-text>
            </ion-item>
          </ion-list>
        }

        <!-- Save Button -->
        <div class="ion-text-center ion-margin-top">
          <ion-button color="success" (click)="save()">
            {{ 'calculator.save' | translate }}
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  }

  <!-- Error Card -->
  @if (errorMessage(); as error) {
    <ion-card class="mainCard2">
      <ion-card-content class="ion-text-center">
        <ion-text color="danger">{{ error }}</ion-text>
      </ion-card-content>
    </ion-card>
  }

  <!-- Saved Confirmation Card -->
  @if (showSavedMessage()) {
    <ion-card class="mainCard2">
      <ion-card-header>
        <ion-card-title class="ion-text-center" id="highlightText2">
          {{ 'calculator.dataSaved' | translate }}
        </ion-card-title>
      </ion-card-header>
    </ion-card>
  }
</ion-content>
